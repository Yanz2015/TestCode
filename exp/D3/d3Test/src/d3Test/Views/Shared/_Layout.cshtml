<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - d3Test</title>

    <environment names="Development">
        <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.css" />
        <link rel="stylesheet" href="~/css/site.css" />
    </environment>
    <environment names="Staging,Production">
        <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.5/css/bootstrap.min.css"
              asp-fallback-href="~/lib/bootstrap/dist/css/bootstrap.min.css"
              asp-fallback-test-class="sr-only" asp-fallback-test-property="position" asp-fallback-test-value="absolute" />
        <link rel="stylesheet" href="~/css/site.min.css" asp-append-version="true" />
    </environment>
    @Html.ApplicationInsightsJavaScript(TelemetryConfiguration)
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a asp-controller="Home" asp-action="Index" class="navbar-brand">d3Test</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li><a asp-controller="Home" asp-action="About">About</a></li>
                    <li><a asp-controller="Home" asp-action="Contact">Contact</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="container body-content">
        @RenderBody()
        <hr />
        <footer>
            <p>&copy; 2016 - d3Test</p>
        </footer>
    </div>

    <environment names="Development">
        <script src="~/lib/jquery/dist/jquery.js"></script>
        <script src="~/lib/bootstrap/dist/js/bootstrap.js"></script>
        <script src="~/lib/d3/d3.js" asp-append-version="true"></script>
        <script src="~/js/sankey.js" asp-append-version="true"></script>
        <script src="~/js/site.js" asp-append-version="true"></script>
    </environment>
    <environment names="Staging,Production">
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.1.4.min.js"
                asp-fallback-src="~/lib/jquery/dist/jquery.min.js"
                asp-fallback-test="window.jQuery">
        </script>
        <script src="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.5/bootstrap.min.js"
                asp-fallback-src="~/lib/bootstrap/dist/js/bootstrap.min.js"
                asp-fallback-test="window.jQuery && window.jQuery.fn && window.jQuery.fn.modal">
        </script>
        <script src="~/lib/d3/d3.min.js" asp-append-version="true"></script>
        <script src="~/js/sankey.js" asp-append-version="true"></script>
        <script src="~/js/site.min.js" asp-append-version="true"></script>
    </environment>

    @RenderSection("scripts", required: false)

    <script type="text/javascript">

        function layoutSankey() {
            try {
                var margin = { top: 1, right: 1, bottom: 6, left: 1 },
                width = 1060 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

                var formatNumber = d3.format(",.0f"),
                format = function (d) { return formatNumber(d) + " TWh"; },
                color = d3.scale.category20();
                $("#sankeyGrap").children().remove();
                var svg = d3.select("#sankeyGrap").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .size([width, height]);

                var path = sankey.link();
                var jsonsrc = $("#source option:selected").val();
                if (typeof (jsonsrc) != 'undefined') {
                    d3.json(jsonsrc, function (energy) {
                        sankey
                            .nodes(energy.nodes)
                            .links(energy.links)
                            .layout(32);

                        var link = svg.append("g").selectAll(".link")
                            .data(energy.links)
                            .enter().append("path")
                            .attr("class", "link")
                            .attr("d", path)
                            .style("stroke-width", function (d) { return Math.max(1, d.dy); })
                            .sort(function (a, b) { return b.dy - a.dy; });

                        link.append("title")
                            .text(function (d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });

                        var node = svg.append("g").selectAll(".node")
                            .data(energy.nodes)
                            .enter().append("g")
                            .attr("class", "node")
                            .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
                            .call(d3.behavior.drag()
                            .origin(function (d) { return d; })
                            .on("dragstart", function () { this.parentNode.appendChild(this); })
                            .on("drag", dragmove));

                        node.append("rect")
                            .attr("height", function (d) { return d.dy; })
                            .attr("width", sankey.nodeWidth())
                            .style("fill", function (d) { return d.color = color(d.name.replace(/ .*/, "")); })
                            .style("stroke", function (d) { return d3.rgb(d.color).darker(2); })
                            .append("title")
                            .text(function (d) { return d.title; });
                        //.text(function (d) { return d.name + "\n" + format(d.value); });

                        node.append("text")
                            .attr("x", -6)
                            .attr("y", function (d) { return d.dy / 2; })
                            .attr("dy", ".35em")
                            .attr("text-anchor", "end")
                            .attr("transform", null)
                            .text(function (d) { return d.name; })
                            .filter(function (d) { return d.x < width / 2; })
                            .attr("x", 6 + sankey.nodeWidth())
                            .attr("text-anchor", "start");

                        function dragmove(d) {
                            d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
                            sankey.relayout();
                            link.attr("d", path);
                        }
                    });
                }

            }
            catch (e) {
                alert(e.message);
            }
        }

        $("#source").change(function () {
            layoutSankey();
        })

        layoutSankey();

    </script>
</body>
</html>
